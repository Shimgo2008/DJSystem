<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DJSystem</title>
<link rel="stylesheet" href="../assets/css/style.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
</head>
<body>
<canvas id="glslCanvas"></canvas>

<div class="content-wrapper">
    <div class="content">
        <h2>Welcome to DJSystem!</h2>
    </div>

    <div class="join">
        <h2>Join a Room</h2>
        <form id="joinRoomForm">
            <div class="join-item">
                <label for="roomId">Room ID</label>
                <input type="text" id="roomId" placeholder="ID" required>
            </div>
            <div class="join-item">
                <label for="password">パスワードを入力(任意)</label>
                <input type="text" id="password" placeholder="pass">
            </div>
            <br>
            <button type="submit" id="joinRoomButton">Join Room</button>
        </form>

        <p style="margin-top: 10px;">
            <a id="createRoomLink" href="#" style="text-align: left; color: #ffe7e7;">if you want to create a room...?</a>
        </p>
    </div>

    <div class="about">
        <h2>about me</h2>
        <p>DJSystemとはSpotifyのプレイリストを複数人で編集できるようにするためのツールです</p>
        <br>
        <p style="text-align: center;">made by Shimgo2008
            <a style="color: #ffe7e7;" href="https://github.com/Shimgo2008/DJSystem/">GitHub</a>
        </p>
    </div>
</div>

<script>
const CLIENT_ID = '671c090ab41e48449f6df3145da6316b';
const REDIRECT_URI = 'https://script.google.com/macros/s/AKfycbzD_i8UpyNYVr_oqacrMAalv-w3IQeCUsjUvSaB6w9uFB-MFCOUZ7TZghDgnOHFLdmVfQ/exec';
const SCOPES = 'playlist-read-private playlist-modify-private playlist-modify-public';
const STATE_KEY = 'spotify_oauth_state';

// ユニーク state を生成
function generateState() {
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
}

// OAuth URL を作る
function getSpotifyAuthURL() {
    const state = generateState();
    localStorage.setItem(STATE_KEY, state);

    const params = new URLSearchParams({
        client_id: CLIENT_ID,
        response_type: 'code',
        redirect_uri: REDIRECT_URI,
        scope: SCOPES,
        state: state,
        show_dialog: 'true'
    });
    return `https://accounts.spotify.com/authorize?${params.toString()}`;
}

// "Create a room" リンクを OAuth に飛ばすように変更
document.getElementById('createRoomLink').addEventListener('click', (e) => {
    e.preventDefault();
    window.location.href = getSpotifyAuthURL();
});

// Join Room フォーム送信
document.getElementById('joinRoomForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const roomId = document.getElementById('roomId').value;
    const password = document.getElementById('password').value;
    alert(`Joining Room: ${roomId} (password: ${password})`);
});
</script>
<script src="../js/background.js"></script>
</body>
</html>
